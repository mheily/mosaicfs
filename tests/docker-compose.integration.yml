version: "3.9"

services:
  couchdb:
    image: docker.io/couchdb:3
    environment:
      COUCHDB_USER: admin
      COUCHDB_PASSWORD: testpassword
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5984/_up"]
      interval: 2s
      timeout: 2s
      retries: 15

  server:
    image: localhost/mosaicfs-dev:latest
    volumes:
      - ../target:/workspace/target:ro
      - server-data:/data/mosaicfs
    environment:
      COUCHDB_URL: http://couchdb:5984
      COUCHDB_USER: admin
      COUCHDB_PASSWORD: testpassword
      MOSAICFS_PORT: "8443"
      MOSAICFS_DATA_DIR: /data/mosaicfs
      RUST_LOG: info
    depends_on:
      couchdb:
        condition: service_healthy
    command: /workspace/target/debug/mosaicfs-server --developer-mode

  agent-1:
    image: localhost/mosaicfs-dev:latest
    hostname: agent-1
    volumes:
      - ../target:/workspace/target:ro
      - agent1-data:/data
      - agent1-files:/test-files
    environment:
      COUCHDB_URL: http://couchdb:5984
      COUCHDB_USER: admin
      COUCHDB_PASSWORD: testpassword
      MOSAICFS_STATE_DIR: /data/state
      RUST_LOG: info
    depends_on:
      couchdb:
        condition: service_healthy
    # Started by the test harness after bootstrap injects agent.toml
    command: sleep infinity

  agent-2:
    image: localhost/mosaicfs-dev:latest
    hostname: agent-2
    volumes:
      - ../target:/workspace/target:ro
      - agent2-data:/data
      - agent2-files:/test-files
    environment:
      COUCHDB_URL: http://couchdb:5984
      COUCHDB_USER: admin
      COUCHDB_PASSWORD: testpassword
      MOSAICFS_STATE_DIR: /data/state
      RUST_LOG: info
    depends_on:
      couchdb:
        condition: service_healthy
    command: sleep infinity

volumes:
  server-data:
  agent1-data:
  agent1-files:
  agent2-data:
  agent2-files:
