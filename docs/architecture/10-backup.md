<\!-- MosaicFS Architecture · ../architecture.md -->

## Backup and Restore

MosaicFS supports two backup strategies: minimal backups that capture only essential user-generated data, and full backups that preserve the entire database including operational history.

### Minimal Backup

A minimal backup contains only documents that cannot be automatically regenerated by agents or would be prohibitively expensive to regenerate. The guiding principle: "Would this data be lost forever if we didn't back it up?" Minimal backups are designed for the clean reinstall use case — wiping CouchDB entirely and starting fresh without losing user work.

**Included document types:**
- `virtual_directory` — user-created directory structure and mount configurations
- `label_assignment` — user-applied labels to individual files
- `label_rule` — user-defined label rules for path prefixes
- `annotation` — plugin-generated metadata. Technically regenerable by running a full plugin sync, but for large deployments this could take hours and incur API costs (AI summarization, OCR services). Safer to preserve.
- `credential` — access key hashes. Without these, every agent and client would need to be re-registered and re-authorized.
- `plugin` — plugin configurations including user-entered settings
- `storage_backend` — storage backend definitions including backend configuration
- `replication_rule` — user-defined replication rules
- Partial `node` documents — specifically the `network_mounts` array from each node. The backup extraction process creates synthetic node documents containing only `_id`, `friendly_name`, and `network_mounts`. On restore, these are merged into the newly-registered node documents via `PATCH /api/nodes/{node_id}`.

**Excluded document types:**
- `file` — regenerated by the agent crawler in minutes on next startup
- `agent_status` — operational snapshot, regenerated on next heartbeat
- `utilization_snapshot` — historical trend data, nice to have but not essential
- `notification` — transient state; conditions recur if still active after restore
- `replica` — regenerable by running a full replication sync; actual file copies on targets are not affected by a CouchDB restore
- `access` — regenerated as files are accessed; loss of access history is acceptable

**Size:** For a deployment with 50,000 files, a minimal backup is typically under 10 MB — it contains a few hundred virtual directory and plugin documents, plus annotations. The file documents (which represent the bulk of the database) are excluded.

### Full Backup

A full backup contains every document in CouchDB: all document types, all history, soft-deleted files, old notifications, utilization snapshots. This is the "disaster recovery" or "migrate to a new control plane host" scenario. The backup is a complete point-in-time snapshot of the database.

The full backup is generated via `GET /mosaicfs/_all_docs?include_docs=true` and written as-is into the JSON file. The restore is a single `POST /mosaicfs/_bulk_docs` call after verifying the database is empty.

**Size:** Proportional to the total indexed file count. A deployment with 50,000 files might produce a 50–100 MB full backup.

### Backup Format

Both backup types use the same format: a JSON file containing an array of CouchDB documents, matching the `_bulk_docs` request format. This means the restore operation is a straightforward bulk write with no transformation required.

**Secret redaction.** Plugin `settings` fields declared as `type: "secret"` in the plugin's `settings_schema` are redacted in backup files — replaced with the sentinel value `"__REDACTED__"`. After restoring from a backup, the user must re-enter secret values via the web UI. The restore endpoint detects `"__REDACTED__"` values and preserves them as-is; the plugin runner treats `"__REDACTED__"` as a missing value and logs a warning. Credential documents are safe — `secret_key_hash` is a one-way Argon2id hash, not the original secret.

```json
{
  "docs": [
    { "_id": "dir::root", "type": "virtual_directory", ... },
    { "_id": "credential::...", "type": "credential", ... },
    { "_id": "plugin::...", "type": "plugin", ... }
  ]
}
```

**Filename convention:** `mosaicfs-backup-minimal-2026-02-16T09-22-00Z.json` and `mosaicfs-backup-full-2026-02-16T09-22-00Z.json`. The ISO 8601 timestamp makes it easy to identify when a backup was taken.

### Restore Process

Restore is only permitted into an empty database. The control plane checks the document count before accepting a restore request and returns an error if any documents exist. This prevents accidentally overwriting a live system.

**Restore steps:**

1. User uploads the backup JSON file via `POST /api/system/restore`
2. Control plane validates the file: checks that `docs` is an array, every document has a `type` field, and all types are recognized
3. For minimal backups: control plane performs a bulk write of all documents except partial node documents; for partial node documents, it extracts the `network_mounts` array and queues it for later merging
4. For full backups: control plane performs a bulk write of all documents
5. Control plane returns a summary: `{ restored_count: N, errors: [...] }`
6. Web UI prompts the user to restart all agents

**Post-restore reconciliation:**

After a minimal backup restore, agents reconnect and discover their node documents are incomplete (no `storage`, no `status`, no `last_heartbeat`). The agent regenerates these fields and performs a full crawl to rebuild the file document collection. The `network_mounts` array restored from the backup is already present in the node document, so the VFS layer's tiered access system works immediately.

For full backup restores, agents see their existing node documents and file documents and perform a standard reconciliation crawl — the mtime/size fast-path means unchanged files are skipped.

### What Is Not Backed Up

**Storage backend OAuth tokens** are stored as encrypted files in `storage-backends/` on the hosting agent, not in CouchDB. They are not included in either backup type. After restore, the user must re-authorize each OAuth-authenticated storage backend via the OAuth flow.

**Plugin-managed external state** — data stored by socket plugins in external systems (Meilisearch indexes, vector databases, external APIs) is not backed up by MosaicFS. Plugins are responsible for their own backup strategies. After restore, a full plugin sync rebuilds external indexes from the file collection.

### Triggering Backups

Backups are on-demand via the REST API and the web UI. The Settings page provides a "Download backup" button with a choice: "Minimal (essential data only)" or "Full (complete database)". The control plane generates the JSON and streams it back as an attachment. The user saves the file wherever they want — local disk, cloud storage, version control.

Scheduled automatic backups are not implemented in v1 but are a natural future extension — a background job that writes backups to a configured destination (S3 bucket, local directory) on a schedule.

---

