version: "3.9"

services:
  dev:
    image: localhost/mosaicfs-dev:latest
    volumes:
      - .:/workspace
      - cargo-cache:/usr/local/cargo/registry  # persist compiled deps across rebuilds
      - claude-data:/root/.claude
    environment:
      - COUCHDB_URL=http://couchdb:5984
      - COUCHDB_USER=admin
      - COUCHDB_PASSWORD=devpassword
    depends_on:
      couchdb:
        condition: service_healthy
    devices:
      - /dev/fuse:/dev/fuse
    # Keep container alive for VS Code / Claude Code to attach to
    command: sleep infinity

  web:
    image: localhost/mosaicfs-dev:latest
    volumes:
      - .:/workspace
      - web-cargo-cache:/usr/local/cargo/registry
      - web-data:/data/mosaicfs
    environment:
      - COUCHDB_URL=http://couchdb:5984
      - COUCHDB_USER=admin
      - COUCHDB_PASSWORD=devpassword
      - MOSAICFS_PORT=8443
      - MOSAICFS_DATA_DIR=/data/mosaicfs
      - RUST_LOG=info
    ports:
      - "8443:8443"   # Axum HTTPS server (serves API + built frontend)
      - "5173:5173"   # Vite dev server (for frontend hot-reload development)
    depends_on:
      couchdb:
        condition: service_healthy
    working_dir: /workspace
    # Run Axum backend in background, then start Vite dev server in foreground.
    # Visit http://localhost:5173 â€” Vite proxies /api to the Axum backend.
    command: >
      bash -c "
        cd web && npm ci &&
        cd /workspace && cargo build -p mosaicfs-server &&
        cargo run -p mosaicfs-server &
        cd /workspace/web && npx vite --host 0.0.0.0
      "

  couchdb:
    image: docker.io/couchdb:3
    environment:
      COUCHDB_USER: admin
      COUCHDB_PASSWORD: devpassword
    ports:
      - "5984:5984"   # expose to host for direct inspection (Fauxton UI, curl, etc.)
    volumes:
      - couchdb-data:/opt/couchdb/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5984/_up"]
      interval: 5s
      timeout: 3s
      retries: 10

volumes:
  couchdb-data:
  cargo-cache:
  web-cargo-cache:
  web-data:
  claude-data:
